<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeneoPro - التحقيق النسبي</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3050/3050431.png">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #1e293b; 
            --accent: #2563eb;
            --bg-body: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --nav-height: 65px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Desktop Sidebar --- */
        .sidebar {
            width: 260px;
            background: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 20;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }
        
        .brand { font-size: 1.4rem; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-menu { list-style: none; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; gap: 12px; align-items: center; transition: 0.2s; color: #cbd5e1; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { border-right: 4px solid var(--accent); }

        /* --- Main Area --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }

        .header {
            background: var(--white); padding: 15px 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }

        .scroll-container {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: 90px; /* Space for mobile nav */
        }

        /* --- Components --- */
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); margin-bottom: 15px; overflow: hidden; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 15px; text-align: right; font-size: 0.85rem; color: #64748b; }
        td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }

        .btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-family: inherit; display: inline-flex; gap: 8px; align-items: center; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-ghost { background: #f1f5f9; color: var(--primary); }

        /* --- Mobile Navigation (Bottom Bar) --- */
        .mobile-nav {
            display: none; /* Hidden on Desktop */
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: white; box-shadow: 0 -2px 15px rgba(0,0,0,0.05);
            justify-content: space-around; align-items: center;
            z-index: 50; padding-bottom: env(safe-area-inset-bottom);
        }

        .mn-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.7rem; color: #94a3b8; gap: 4px; width: 100%; height: 100%;
        }
        .mn-item i { font-size: 1.2rem; transition: 0.2s; }
        .mn-item.active { color: var(--accent); font-weight: bold; }
        .mn-item.active i { transform: translateY(-2px); }

        /* --- Floating Action Button (FAB) --- */
        .fab-btn {
            display: none; position: fixed; bottom: 80px; left: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--accent); color: white; border: none;
            box-shadow: 0 4px 15px rgba(37,99,235,0.4);
            font-size: 1.5rem; align-items: center; justify-content: center;
            z-index: 40; cursor: pointer; transition: 0.2s;
        }
        .fab-btn:active { transform: scale(0.95); }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .sidebar { display: none; } /* Hide Sidebar */
            .mobile-nav { display: flex; } /* Show Bottom Nav */
            .fab-btn { display: flex; } /* Show FAB */
            .desktop-only { display: none !important; }
            
            .header h1 { font-size: 1.1rem; }
            th, td { padding: 12px 10px; font-size: 0.9rem; }
            
            /* Transform Table to Cards for better mobile view if needed, keeping simple table for now */
        }

        /* --- Footer --- */
        .app-footer {
            text-align: center; padding: 20px; margin-top: 20px;
            border-top: 2px solid #e2e8f0; color: #64748b;
        }
        .dev-badge {
            background: var(--primary); color: white; padding: 5px 12px;
            border-radius: 20px; font-size: 0.75rem; display: inline-block; margin-top: 5px;
        }

        /* --- Status Badges --- */
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .st-ok { background: #dcfce7; color: #15803d; }
        .st-err { background: #fee2e2; color: #b91c1c; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100; display: none; 
            align-items: flex-end; /* Bottom sheet on mobile */
        }
        .modal-box {
            background: white; width: 100%; border-radius: 20px 20px 0 0;
            padding: 25px; animation: slideUp 0.3s ease;
        }
        @media (min-width: 769px) {
            .modal-overlay { align-items: center; justify-content: center; }
            .modal-box { width: 500px; border-radius: 15px; }
        }
        @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)} }

        .inp-group { margin-bottom: 15px; }
        .inp-group label { display: block; margin-bottom: 5px; font-weight:bold; font-size:0.9rem;}
        .inp-group input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-dna" style="color:var(--accent)"></i> GeneoPro
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" onclick="app.nav('home')"><i class="fa-solid fa-list"></i> السجل</li>
            <li class="nav-item" onclick="app.nav('timeline')"><i class="fa-solid fa-chart-bar"></i> الزمن</li>
            <li class="nav-item" onclick="app.backup()"><i class="fa-solid fa-cloud-arrow-down"></i> نسخ احتياطي</li>
        </ul>
        
        <div style="margin-top:auto; font-size:0.8rem; color:#94a3b8; text-align:center;">
            تطوير <br> <strong style="color:white">أ. عنتر ضيف الله</strong>
        </div>
    </aside>

    <div class="main-content">
        <header class="header">
            <div>
                <h1 style="margin:0; font-size:1.2rem;">GeneoPro</h1>
                <span style="font-size:0.75rem; color:#64748b">التحقيق النسبي الذكي</span>
            </div>
            <button class="btn btn-primary desktop-only" onclick="app.openModal('new')">
                <i class="fa-solid fa-plus"></i> إضافة جد
            </button>
        </header>

        <div class="scroll-container">
            <div id="view-home">
                <div class="card">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th width="10%">م</th>
                                <th>الاسم</th>
                                <th width="20%">السنة</th>
                                <th width="20%">الحالة</th>
                                <th width="15%"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                    <div id="emptyState" style="padding:40px; text-align:center; color:#94a3b8; display:none;">
                        <i class="fa-solid fa-box-open" style="font-size:2rem; margin-bottom:10px;"></i>
                        <p>لا توجد بيانات.. ابدأ الآن</p>
                    </div>
                </div>
            </div>

            <div id="view-timeline" style="display:none;">
                <div class="card" style="padding:20px; text-align:center; color:#64748b;">
                    <i class="fa-solid fa-wrench" style="font-size:2rem; margin-bottom:10px;"></i>
                    <p>سيتم تفعيل المخطط البياني في التحديث القادم</p>
                </div>
            </div>

            <footer class="app-footer">
                <div style="font-weight:bold; margin-bottom:5px;">Genealogy Pro System v2.0</div>
                <div>برمجة وتطوير وتحليل</div>
                <div class="dev-badge">أ. عنتر ضيف الله</div>
                <div style="font-size:0.7rem; margin-top:10px;">All Rights Reserved © 2025</div>
            </footer>
        </div>
    </div>

    <nav class="mobile-nav">
        <div class="mn-item active" onclick="app.nav('home')">
            <i class="fa-solid fa-list-ul"></i> <span>السجل</span>
        </div>
        <div class="mn-item" onclick="app.nav('timeline')">
            <i class="fa-solid fa-clock-rotate-left"></i> <span>الزمن</span>
        </div>
        <div class="mn-item" onclick="app.backup()">
            <i class="fa-solid fa-download"></i> <span>حفظ</span>
        </div>
    </nav>

    <button class="fab-btn" onclick="app.openModal('new')">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">بيانات الجد</h3>
                <i class="fa-solid fa-times" onclick="app.closeModal()" style="padding:10px; cursor:pointer;"></i>
            </div>
            
            <div class="inp-group">
                <label>الاسم الكامل</label>
                <input type="text" id="pName" placeholder="الاسم">
            </div>
            <div class="inp-group">
                <label>سنة الميلاد (اختياري)</label>
                <input type="number" id="pBirth" placeholder="اتركها فارغة للتقدير">
            </div>
            <div class="inp-group">
                <label>نوع التوثيق</label>
                <select id="pDoc">
                    <option value="حسابي">استنتاج حسابي</option>
                    <option value="رسمي">وثيقة رسمية</option>
                    <option value="مشجر">مشجر عائلي</option>
                </select>
            </div>
            
            <input type="hidden" id="pIdx">
            <button class="btn btn-primary" style="width:100%; justify-content:center; padding:12px;" onclick="app.save()">حفظ البيانات</button>
        </div>
    </div>

<script>
// Register Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => console.log('SW Ready'));
}

class App {
    constructor() {
        this.data = JSON.parse(localStorage.getItem('Geneo_v2_DB')) || [];
        this.render();
    }

    process() {
        if (!this.data.length) return [];
        let list = JSON.parse(JSON.stringify(this.data));
        let anchor = list[0].birth ? parseInt(list[0].birth) : new Date().getFullYear();
        
        list.forEach((p, i) => {
            if(p.birth) { p.cB = parseInt(p.birth); p.est = false; anchor = p.cB; }
            else { p.cB = (i===0) ? anchor : anchor - 33; p.est = true; anchor = p.cB; }
            
            if(i > 0) p.gap = list[i-1].cB - p.cB;
            else p.gap = null;
        });
        return list;
    }

    render() {
        const list = this.process();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        if(list.length === 0) document.getElementById('emptyState').style.display = 'block';
        else document.getElementById('emptyState').style.display = 'none';

        list.forEach((p, i) => {
            let status = '<span class="badge" style="background:#e2e8f0; color:#64748b">بداية</span>';
            if(p.gap !== null) {
                if(p.gap < 15) status = `<span class="badge st-err">حشو (${p.gap})</span>`;
                else status = `<span class="badge st-ok">متزن (${p.gap})</span>`;
            }

            tbody.innerHTML += `
                <tr>
                    <td>${i*-1}</td>
                    <td>
                        <div style="font-weight:bold; font-size:0.95rem;">${p.name}</div>
                        <div style="font-size:0.75rem; color:#94a3b8;">${p.doc}</div>
                    </td>
                    <td>
                        ${p.cB}
                        ${p.est ? '<span style="font-size:0.7rem; color:#cbd5e1">(ت)</span>' : ''}
                    </td>
                    <td>${status}</td>
                    <td>
                        <i class="fa-solid fa-pen-to-square" style="color:var(--accent); padding:5px;" onclick="app.openModal(${i})"></i>
                        <i class="fa-solid fa-trash" style="color:#ef4444; padding:5px;" onclick="app.del(${i})"></i>
                    </td>
                </tr>
            `;
        });
        localStorage.setItem('Geneo_v2_DB', JSON.stringify(this.data));
    }

    openModal(idx) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('pIdx').value = idx;
        if(idx === 'new') {
            document.getElementById('pName').value = '';
            document.getElementById('pBirth').value = '';
        } else {
            const p = this.data[idx];
            document.getElementById('pName').value = p.name;
            document.getElementById('pBirth').value = p.birth || '';
            document.getElementById('pDoc').value = p.doc;
        }
    }

    closeModal() { document.getElementById('modal').style.display = 'none'; }

    save() {
        const obj = {
            name: document.getElementById('pName').value,
            birth: document.getElementById('pBirth').value,
            doc: document.getElementById('pDoc').value
        };
        if(!obj.name) return alert('الاسم مطلوب');
        
        const idx = document.getElementById('pIdx').value;
        if(idx === 'new') this.data.push(obj);
        else this.data[idx] = obj;
        
        this.closeModal();
        this.render();
    }

    del(idx) { if(confirm('حذف؟')) { this.data.splice(idx, 1); this.render(); } }

    nav(view) {
        // Simple view toggler
        document.getElementById('view-home').style.display = view === 'home' ? 'block' : 'none';
        document.getElementById('view-timeline').style.display = view === 'timeline' ? 'block' : 'none';
        
        // Active State Logic
        document.querySelectorAll('.mn-item, .nav-item').forEach(el => el.classList.remove('active'));
        // (Simplified for brevity - in real app assign IDs to nav items)
    }

    backup() {
        const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
        const a = document.createElement('a'); a.href = str; a.download = "backup.json"; a.click();
    }
}

const app = new App();
</script>

</body>
</html>
