<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeneoPro - Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3050/3050431.png">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª --- */
        :root {
            --primary: #1e293b; 
            --accent: #2563eb;
            --bg-body: #f8fafc;
            --border: #e2e8f0;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø§Ù… --- */
        .sidebar {
            width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; z-index: 20;
        }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; height: 100%; }
        .header { background: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .scroll-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }

        /* --- Ø§Ù„Ø¹Ù†Ø§ØµØ± --- */
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); margin-bottom: 15px; overflow: hidden; }
        .btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-family: inherit; display: inline-flex; gap: 8px; align-items: center; }
        .btn-primary { background: var(--accent); color: white; }

        /* --- Ø§Ù„Ø¬Ø¯ÙˆÙ„ --- */
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 12px; text-align: right; color: #64748b; font-size: 0.85rem; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }

        /* --- Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Timeline Styles) --- */
        .timeline-wrapper {
            padding: 20px;
            overflow-x: auto; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø£ÙÙ‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
        }
        .chart-container {
            min-width: 600px; /* Ø¹Ø±Ø¶ Ø£Ø¯Ù†Ù‰ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù†Ø¶ØºØ§Ø· Ø§Ù„Ø±Ø³Ù… */
            position: relative;
            direction: ltr; /* Ø§Ù„Ù…Ø®Ø·Ø· Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† (Ø§Ù„Ù…Ø§Ø¶ÙŠ -> Ø§Ù„Ø­Ø§Ø¶Ø±) */
        }
        .chart-header {
            display: flex; justify-content: space-between; border-bottom: 2px solid #cbd5e1; margin-bottom: 10px; font-size: 0.8rem; color: #64748b; font-weight: bold;
        }
        .chart-row {
            display: flex; align-items: center; margin-bottom: 12px; position: relative; height: 35px;
        }
        .chart-label {
            position: absolute; right: 10px; /* Ø§Ù„Ø§Ø³Ù… ÙŠØ¸Ù‡Ø± ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø±ÙŠØ· */
            font-size: 0.75rem; font-weight: bold; color: var(--primary); width: 100px; text-align: right; direction: rtl; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø²Ù…Ù† */
        .chart-bar {
            position: absolute; height: 12px; border-radius: 6px; top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: width 1s ease;
        }
        .bar-real { background: linear-gradient(90deg, #2563eb, #3b82f6); }
        .bar-est { background: repeating-linear-gradient(45deg, #cbd5e1, #cbd5e1 5px, #e2e8f0 5px, #e2e8f0 10px); border: 1px solid #94a3b8; }
        
        /* Ø®Ø·ÙˆØ· Ø§Ù„Ø´Ø¨ÙƒØ© */
        .grid-line { position: absolute; top: 0; bottom: 0; width: 1px; background: #f1f5f9; z-index: 0; }

        /* --- Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ø¬ÙˆØ§Ù„ --- */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; width: 100%; height: 65px; background: white; border-top: 1px solid var(--border); justify-content: space-around; align-items: center; z-index: 50;
        }
        .mn-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #94a3b8; gap: 4px; }
        .mn-item.active { color: var(--accent); font-weight: bold; }
        
        /* --- Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ --- */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            .desktop-only { display: none !important; }
        }

        /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 90%; max-width: 450px; padding: 20px; border-radius: 15px; }
        .inp-group { margin-bottom: 15px; }
        .inp-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .inp-group input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div style="font-size:1.4rem; font-weight:900; margin-bottom:30px; display:flex; align-items:center; gap:10px;">
            <i class="fa-solid fa-dna" style="color:var(--accent)"></i> GeneoPro
        </div>
        <div class="nav-menu" style="display:flex; flex-direction:column; gap:10px;">
            <div class="btn btn-primary" onclick="app.openModal('new')" style="justify-content:center; margin-bottom:20px;">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ +</div>
            <div class="mn-item active" onclick="app.nav('home')" style="flex-direction:row; gap:10px; font-size:1rem; cursor:pointer;">
                <i class="fa-solid fa-list"></i> Ø§Ù„Ø³Ø¬Ù„
            </div>
            <div class="mn-item" onclick="app.nav('timeline')" style="flex-direction:row; gap:10px; font-size:1rem; cursor:pointer;">
                <i class="fa-solid fa-chart-gantt"></i> Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
            </div>
        </div>
    </aside>

    <div class="main-content">
        <header class="header">
            <div>
                <h1 style="font-size:1.1rem; margin:0;">Genealogy Pro</h1>
                <small style="color:#64748b">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù†Ø³Ø¨ÙŠ</small>
            </div>
            <button class="btn btn-primary desktop-only" onclick="app.openModal('new')"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
        </header>

        <div class="scroll-container">
            
            <div id="view-home">
                <div class="card">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th width="10%">Ù…</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th width="25%">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th width="15%"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                    <div id="emptyState" style="padding:40px; text-align:center; display:none; color:#94a3b8;">
                        <i class="fa-solid fa-folder-open" style="font-size:2rem;"></i>
                        <p>Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº</p>
                    </div>
                </div>
            </div>

            <div id="view-timeline" style="display:none;">
                <div class="card">
                    <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">
                        <h3 style="margin:0; font-size:1rem;">Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ø£Ø¬ÙŠØ§Ù„</h3>
                        <small style="color:#64748b">Ø§Ù„Ø£Ø²Ø±Ù‚: Ù…ÙˆØ«Ù‚ | Ø§Ù„Ù…Ø®Ø·Ø·: ØªÙ‚Ø¯ÙŠØ±ÙŠ</small>
                    </div>
                    <div class="timeline-wrapper">
                        <div id="chartCanvas" class="chart-container">
                            </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <nav class="mobile-nav">
        <div class="mn-item active" onclick="app.nav('home')"><i class="fa-solid fa-list"></i> Ø§Ù„Ø³Ø¬Ù„</div>
        <div class="mn-item" onclick="app.nav('timeline')"><i class="fa-solid fa-chart-bar"></i> Ø§Ù„Ù…Ø®Ø·Ø·</div>
        <div class="mn-item" onclick="app.openModal('new')"><i class="fa-solid fa-circle-plus" style="font-size:1.8rem; color:var(--accent);"></i></div>
        <div class="mn-item" onclick="app.backup()"><i class="fa-solid fa-download"></i> Ø­ÙØ¸</div>
    </nav>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom:15px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
            <div class="inp-group">
                <label>Ø§Ù„Ø§Ø³Ù…</label>
                <input type="text" id="pName">
            </div>
            <div class="inp-group">
                <label>Ø³Ù†Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
                <input type="number" id="pBirth" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ù„ØªÙ‚Ø¯ÙŠØ±">
            </div>
            <div class="inp-group">
                <label>Ø³Ù†Ø© Ø§Ù„ÙˆÙØ§Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="number" id="pDeath" placeholder="Ù„Ø¶Ø¨Ø· Ø·ÙˆÙ„ Ø§Ù„Ø´Ø±ÙŠØ·">
            </div>
            <input type="hidden" id="pIdx">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#f1f5f9; flex:1;" onclick="app.closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="btn btn-primary" style="flex:1;" onclick="app.save()">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

class App {
    constructor() {
        this.data = JSON.parse(localStorage.getItem('Geneo_v3_DB')) || [];
        this.render();
    }

    process() {
        if (!this.data.length) return [];
        let list = JSON.parse(JSON.stringify(this.data));
        let anchor = list[0].birth ? parseInt(list[0].birth) : new Date().getFullYear();
        
        list.forEach((p, i) => {
            // Birth
            if(p.birth) { p.cB = parseInt(p.birth); p.est = false; anchor = p.cB; }
            else { p.cB = (i===0)? anchor : anchor - 33; p.est = true; anchor = p.cB; }
            
            // Death (For Chart Width)
            if(p.death) { p.cD = parseInt(p.death); }
            else { p.cD = p.cB + 65; } // Default lifespan 65 years
        });
        return list;
    }

    render() {
        const list = this.process();
        this.renderTable(list);
        this.renderChart(list);
        localStorage.setItem('Geneo_v3_DB', JSON.stringify(this.data));
    }

    renderTable(list) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if(!list.length) document.getElementById('emptyState').style.display='block';
        else document.getElementById('emptyState').style.display='none';

        list.forEach((p, i) => {
            tbody.innerHTML += `
                <tr>
                    <td>${i*-1}</td>
                    <td><b>${p.name}</b></td>
                    <td>${p.cB} ${p.est ? '<small style="color:#ccc">(Øª)</small>' : ''}</td>
                    <td>
                        <i class="fa-solid fa-pen" style="color:var(--accent); margin-left:10px;" onclick="app.openModal(${i})"></i>
                        <i class="fa-solid fa-trash" style="color:#ef4444;" onclick="app.del(${i})"></i>
                    </td>
                </tr>`;
        });
    }

    // --- ğŸ”¥ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ğŸ”¥ ---
    renderChart(list) {
        const container = document.getElementById('chartCanvas');
        container.innerHTML = '';
        if(list.length === 0) return;

        // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ (Scale)
        // Ù†Ø£Ø®Ø° Ø£Ù‚Ø¯Ù… Ø³Ù†Ø© ÙˆØ£Ø­Ø¯Ø« Ø³Ù†Ø© Ù…Ø¹ Ù‡Ø§Ù…Ø´ Ø¨Ø³ÙŠØ·
        const minYear = list[list.length-1].cB - 10; 
        const maxYear = list[0].cD + 10;
        const totalYears = maxYear - minYear;

        // 2. Ø±Ø³Ù… Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø·Ø±Ø©)
        let headerHTML = '<div class="chart-header">';
        headerHTML += `<span>${minYear}</span>`;
        headerHTML += `<span>Ù…Ù†ØªØµÙ Ø§Ù„Ø­Ù‚Ø¨Ø© (${Math.round((minYear+maxYear)/2)})</span>`;
        headerHTML += `<span>${maxYear}</span>`;
        headerHTML += '</div>';
        container.innerHTML += headerHTML;

        // 3. Ø±Ø³Ù… Ø§Ù„ØµÙÙˆÙ
        list.forEach((p, i) => {
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø¹Ø±Ø¶
            const startPct = ((p.cB - minYear) / totalYears) * 100;
            const widthPct = ((p.cD - p.cB) / totalYears) * 100;

            const barClass = p.est ? 'bar-est' : 'bar-real';
            
            container.innerHTML += `
                <div class="chart-row">
                    <div class="chart-bar ${barClass}" style="left: ${startPct}%; width: ${widthPct}%;"></div>
                    <div class="chart-label" style="left: ${startPct + widthPct + 1}%;">${p.name}</div>
                </div>
            `;
        });
    }

    nav(view) {
        document.getElementById('view-home').style.display = view==='home'?'block':'none';
        document.getElementById('view-timeline').style.display = view==='timeline'?'block':'none';
    }

    openModal(idx) {
        document.getElementById('modal').style.display='flex';
        document.getElementById('pIdx').value = idx;
        if(idx==='new'){
            document.getElementById('pName').value='';
            document.getElementById('pBirth').value='';
            document.getElementById('pDeath').value='';
        } else {
            const p = this.data[idx];
            document.getElementById('pName').value=p.name;
            document.getElementById('pBirth').value=p.birth||'';
            document.getElementById('pDeath').value=p.death||'';
        }
    }

    closeModal() { document.getElementById('modal').style.display='none'; }
    
    save() {
        const obj = {
            name: document.getElementById('pName').value,
            birth: document.getElementById('pBirth').value,
            death: document.getElementById('pDeath').value
        };
        if(!obj.name) return alert('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨');
        const idx = document.getElementById('pIdx').value;
        if(idx==='new') this.data.push(obj); else this.data[idx]=obj;
        this.closeModal(); this.render();
    }

    del(idx) { if(confirm('Ø­Ø°ÙØŸ')) { this.data.splice(idx,1); this.render(); } }
    backup() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
        a.download = "backup.json"; a.click();
    }
}
const app = new App();
</script>
</body>
</html>
